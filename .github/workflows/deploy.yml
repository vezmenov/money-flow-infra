name: Deploy To Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Sync repos and deploy
        shell: bash
        run: |
          set -euo pipefail

          sync_repo() {
            local dir="$1"
            local url="$2"
            if [ ! -d "$dir/.git" ]; then
              git clone "$url" "$dir"
            fi
            git -C "$dir" fetch origin main
            git -C "$dir" checkout main
            git -C "$dir" pull --ff-only origin main
          }

          mkdir -p "$HOME/apps"
          sync_repo "$HOME/apps/money-flow" "https://github.com/vezmenov/money-flow.git"
          sync_repo "$HOME/apps/money-flow-backend" "https://github.com/vezmenov/money-flow-backend.git"
          sync_repo "$HOME/apps/money-flow-infra" "https://github.com/vezmenov/money-flow-infra.git"

          cd "$HOME/apps/money-flow-infra"
          docker compose up -d --build
          docker compose ps
