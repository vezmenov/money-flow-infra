name: Deploy To Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Sync repos and deploy
        shell: bash
        run: |
          set -euo pipefail

          sync_repo() {
            local dir="$1"
            local url="$2"
            if [ ! -d "$dir/.git" ]; then
              git clone "$url" "$dir"
            fi
            git -C "$dir" fetch origin main
            git -C "$dir" checkout main
            git -C "$dir" pull --ff-only origin main
          }

          mkdir -p "$HOME/apps"
          sync_repo "$HOME/apps/money-flow" "https://github.com/vezmenov/money-flow.git"
          sync_repo "$HOME/apps/money-flow-backend" "https://github.com/vezmenov/money-flow-backend.git"
          sync_repo "$HOME/apps/money-flow-infra" "https://github.com/vezmenov/money-flow-infra.git"

          FRONTEND_SHA="$(git -C "$HOME/apps/money-flow" rev-parse --short HEAD)"
          BACKEND_SHA="$(git -C "$HOME/apps/money-flow-backend" rev-parse --short HEAD)"
          INFRA_SHA="$(git -C "$HOME/apps/money-flow-infra" rev-parse --short HEAD)"
          BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          export APP_BUILD_VERSION="$FRONTEND_SHA"
          export APP_BUILD_TIME="$BUILD_TIME"

          echo "Deploying frontend build version: $APP_BUILD_VERSION"
          echo "Build time (UTC): $APP_BUILD_TIME"

          if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            {
              echo "### Deploy Info"
              echo "- Frontend SHA: \`$FRONTEND_SHA\`"
              echo "- Backend SHA: \`$BACKEND_SHA\`"
              echo "- Infra SHA: \`$INFRA_SHA\`"
              echo "- Frontend build version: \`$APP_BUILD_VERSION\`"
              echo "- Build time (UTC): \`$APP_BUILD_TIME\`"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          cd "$HOME/apps/money-flow-infra"
          docker compose up -d --build
          docker compose ps
